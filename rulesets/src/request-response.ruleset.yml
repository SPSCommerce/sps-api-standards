rules:
  ##### General #####
  sps-invalid-response-body:
    description: Response bodies must be objects, not arrays
    severity: error
    given: "$.paths[*][*].responses[*].content.application/json.schema"
    then:
      function: schema
      functionOptions:
        schema:
          not:
            type: array

  ##### HTTP Status Codes #####
  sps-invalid-status-code:
    description: An API MUST return HTTP response codes in conformance with RFC-2616 and common usage.
    severity: error
    given: $.paths...responses.*~
    then:
      function: enumeration
      functionOptions:
        values: ["200", "201", "202", "204", "400", "401", "403", "404", "405", "406", "409", "412", "415", "428", "429", "500"]

  # sps-missing-2xx-response:
  #   description: "Every endpoint must have at least one 2xx success response"
  #   severity: error
  #   given: "$.paths[*][*].responses"
  #   then:
  #     function: schema
  #     functionOptions:
  #       schema:
  #         type: object
  #         patternProperties:
  #           "^2[0-9]{2}$":
  #             type: object
  #         not:
  #           type: object
  #           additionalProperties:
  #             not:
  #               type: object
  #         minProperties: 1

    # given: $.paths[*][*].responses[?(@property.match(/^2[0-9]{2}$/))]
    # then:
    #   function: truthy

  #   sps-missing-5xx-response:
  #     description: "Every endpoint must have at least one 5xx error response"
  #     severity: error
  #     given: $.paths...responses.*~
  #     then:
  #       function: schema
  #       functionOptions:
  #         schema:
  #           type: object
  #           properties:
  #             responses:
  #               type: object
  #               patternProperties:
  #                 "^5[0-9]{2}$": {}
  #           required:
  #             - responses
  #           minProperties: 1

  ##### HTTP Headers #####
  sps-headers-hyphenated-pascal-case:
    description: All `HTTP` headers MUST use `Hyphenated-Pascal-Case` notation
    severity: error
    given: "$..parameters[?(@.in == 'header')].name"
    message: "'HTTP' headers MUST follow 'Hyphenated-Pascal-Case' notation"
    type: style
    then: 
      function: pattern
      functionOptions:
        match: "/^([A-Z][a-z0-9]-)*([A-Z][a-z0-9])+/"

  sps-no-x-headers:
    description: "Do not use headers with X-"
    severity: warn
    message: "Headers cannot start with X-. More: https://tools.ietf.org/html/rfc6648"
    given: "$..parameters.[?(@.in === 'header')].name"
    then:
      function: pattern
      functionOptions:
        notMatch: '^(x|X)-'
 
  sps-no-x-response-headers:
    description: "Do not use headers with X-"
    severity: warn
    message: "Headers cannot start with X-, so please find a new name for {{property}}. More: https://tools.ietf.org/html/rfc6648"
    given: "$..headers.*~"
    then:
      function: pattern
      functionOptions:
        notMatch: '^(x|X)-'

  ##### MIME Types #####

  ##### HTTP Methods #####
  sps-invalid-http-method:
  # TODO: what's a better way to phrase this description
    description: Operations MUST use only the common HTTP methods as outlined in the document, and must be in lower-case
    severity: error
    given: $.paths[*].*~
    then:
      field: "method"
      function: enumeration
      functionOptions:
        values: ["get", "post", "put", "patch", "delete", "head", "options"]

  sps-request-get-no-body:
    description: A `GET` request MUST NOT accept a request body
    severity: error
    given: $.paths[*][get].requestBody
    then:
      function: undefined

  sps-response-get-missing-body:
    description: A `GET` operation must return a response body
    severity: error
    given: $.paths[*].get.responses[*]
    then:
      field: "content"
      function: "truthy"
      message: "GET operations must include a response body."

  sps-invalid-get-response-code:
    description: "GET operations should not use status codes 201, 202, 204, 409, 412"
    severity: warn
    given: $.paths[*].get.responses
    then:
      function: "pattern"
      functionOptions:
        notMatch: "^(201|202|204|409|412)$"
      message: "GET operations should not use status codes 201, 202, 204, 409, 412"

  sps-response-get-missing-code:
    description: GET operations must always return both 200 and 404 status codes
    severity: error
    given: $.paths[*].get.responses
    then:
      - field: "200"
        function: truthy
      - field: "404"
        function: truthy

  sps-invalid-post-response-code:
    description: POST operations should not return 204 or 412 status codes
    given: $.paths[*].post.responses
    severity: warn
    then:
      field: "@key"
      function: pattern
      functionOptions:
        notMatch: "^(204|412)$"

  sps-invalid-put-response-code:
    description: PUT operations should not return 200 or 201 status codes
    severity: warn
    given: $.paths[*].put.responses
    then:
      field: "@key"
      function: pattern
      functionOptions:
        notMatch: "^(200|201)$"

  sps-invalid-delete-response-code:
    description: DELETE operations should not return 200 or 201 status codes
    severity: warn
    given: $.paths[*].delete.responses
    then:
      field: "@key"
      function: pattern
      functionOptions:
        notMatch: "^(200|201)$"